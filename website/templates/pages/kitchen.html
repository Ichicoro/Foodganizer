{% extends "base.html" %}
{% load jsondumps %}
{% load crispy_forms_tags %}
{% load tz %}

{% load crispy_forms_tags %}

{% now "d-m-yy" as today_date %}

{% block head %}
    {% include "csvalidation.html" %}
    <style>
        #div_id_item { position: absolute; visibility:hidden; }
        #div_id_expiry_date { margin-bottom: 10px !important; }
        .si-image {
            flex-shrink: 1;
            max-width: 48px;
            margin-right: 16px;
            max-height: 48px;
        }
    </style>
    <script src="/static/js/Card3D.js" type="module"></script>
    <script type="module">
        {% if invite_users_form_open %}
            new bootstrap.Modal($$("#inviteUsersModal")).show()
        {% endif %}
        
        $$all(".stored-item-btn").forEach(item => item.addEventListener("click", _ => {
            const itemJsonData = JSON.parse(item.dataset.itemJson)
            const instanceJsonData = JSON.parse(item.dataset.storedItemJson)
            console.log(item.dataset)

            // $$("#itemInfoModal form").action = `/kitchens/{{ kitchen.id }}/update/${item.dataset.itemId}`


            $$("#itemInfoModal form").action = "{% url "update_item_kitchen" id=kitchen.id item_id="00000000" %}".replace("00000000", item.dataset.itemId)

            $$all("#itemInfoModal #item-name, #removeItemModal #item-name").forEach(_ => _.textContent = itemJsonData["title"])
            $$("#itemInfoModal #item-desc").textContent = itemJsonData["description"]
            $$("#itemInfoModal #item-added-by").textContent = itemJsonData["added_by"][0]
            $$("#itemInfoModal #item-added-by").href = `/profile/${itemJsonData["added_by"][0]}`
            $$("#itemInfoModal #id_quantity").value = instanceJsonData["quantity"]
            $$("#itemInfoModal #id_note").textContent = instanceJsonData["note"]
            $$("#itemInfoModal #id_expiry_date").value = instanceJsonData["expiry_date"]
            $$("#removeItemModal #id_item").value = parseInt(item.dataset.itemId)

            new bootstrap.Modal($$("#itemInfoModal")).show()
        }))
        {#$$all(".stored-item-btn")[0].click()#}
    </script>
{% endblock %}

{% block body %}
    <div class="container-fluid mw-md mb-5">
        <h1 class="mb-3">{{ kitchen.name }}</h1>
        <div class="row">
            <div class="col-md-6 col-sm-12 mb-4">
                <h3>Members</h3>
                <div class="list-group mb-4">
                    {% for m in memberships %}
                        <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
                            <div class="me-auto">
                                <div class="fw-bold mb-0">@{{ m.user.username }}</div>
                                {% if m.user.first_name or m.user.last_name %}
                                    <span>Full name: <b>{{ m.user.first_name }} {{m.user.last_name}}</b></span><br />
                                {% endif %}
                                {% if m.user.email %}
                                    <span>Email: <span class="monospaced">{{ m.user.email }}</span></span>
                                {% endif %}
                            </div>
                            {% if m.is_admin %}
                                <span class="badge rounded-pill bg-danger">Admin</span>
                            {% endif %}
                        </a>
                    {% empty %}
                        <li class="list-group-item">
                            No users
                        </li>
                    {% endfor %}
                    <a onClick='new bootstrap.Modal($$("#inviteUsersModal")).show()' class="list-group-item list-group-item-action list-group-item-success text-center" id="invite-user-btn">
                        <i class="bi bi-plus-lg"></i>&nbsp;&nbsp;Invite user
                    </a>
                </div>
                <div class="mt-3">
                    <h3>PostIt</h3>
                <ul class="list-group">
                    {% for p in postit %}
                        <li class="list-group-item">
                            {# TODO: Missing stuff #}
                            {{ p.text }}
                        </li>
                    {% empty %}
                        <li class="list-group-item text-center text-muted">
                            <i>No PostIt</i>
                        </li>
                    {% endfor %}
                    <a class="list-group-item list-group-item-action list-group-item-success text-center" id="create-private-item-btn">
                        <i class="bi bi-plus-lg"></i>&nbsp;&nbsp;Create new
                    </a>
                </ul>
                </div>
            </div>
            <div class="col-md-6 col-sm-12">
                <h3>Items</h3>
                <div class="list-group list-group-item-action">
                    {% for si in stored_items %}
                        <a class="list-group-item list-group-item-action stored-item-btn" data-item-id="{{ si.id }}" data-item-is-custom="true" data-item-json="{{ si.item|json }}" data-stored-item-json="{{ si|json }}" data-item-name="{{ si }}">
                            <div class="d-flex my-1">
                                <div class="card3d si-image me-3">
                                    <img src="/static/media/{% firstof si.image "question_mark.png" %}" alt="item image" class="{% comment %}my-1{% endcomment %} rounded ratio-1x1" style="width: 48px; height: 48px; object-fit: cover">
                                </div>
                                <div class="me-auto">
                                    <div class="fw-bold mb-1">
                                        {{ si.item.title }}
                                    </div>
                                    <div class="text-muted fst-italic mb-1">{% firstof si.note si.item.description "No description..." %}</div>
                                    <div class="text-muted small{% if si.expiry_date|utc < now|utc %} text-danger{% endif %}">
                                        Expires on {{ si.expiry_date|date:"d-m-yy" }}
                                    </div>
                                </div>
                                <div style="margin-top: -2.5px; width: 48px; height: 48px" class="text-center font-iosevka {% comment %}mb-2{% endcomment %}">
                                    <p class="small text-muted {% comment %}mt-3{% endcomment %} mb-0">AMOUNT</p>
                                    <b style="font-size: 24px">{{ si.quantity }}</b>
                                </div>
                            </div>
                        </a>
                    {% empty %}
                        <a class="list-group-item text-center">
                            <i class="text-muted"><i class="bi bi-"></i>No items</i>
                        </a>
                    {% endfor %}
                    <a class="list-group-item list-group-item-action list-group-item-success text-center" href="{% url 'add_item_kitchen' id=kitchen.id %}">
                        <i class="bi bi-plus-lg"></i>&nbsp;&nbsp;Add item
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="itemInfoModal" tabindex="-1" aria-labelledby="itemInfoModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <form novalidate method="POST">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="item-name">Item info</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-muted mb-3">
                            <p class="text-muted fst-italic mb-0" id="item-desc"></p>
                            &ndash;&nbsp;<a class="fst-italic" id="item-added-by" href="/profile"></a>
                        </div>
                        {% comment %}<label for="id_quantity" class="form-label mt-3">Quantity</label>
                        <input required type="number" class="form-control" id="id_quantity" min="0" oninput="validity.valid||(value='');" />

                        <label for="id_note" class="form-label mt-3">Note</label>
                        <textarea type="text" class="form-control fst-italic" id="id_note"></textarea>{% endcomment %}

                        {{ update_item_form|crispy }}
                    </div>
                    <div class="modal-footer d-flex">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#removeItemModal"><i class="bi bi-trash-fill flex-grow-0"></i>{% comment %}&nbsp;&nbsp;Remove{% endcomment %}</button>
                        <button type="submit" class="btn btn-success flex-grow-1">Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="removeItemModal" tabindex="-1" aria-labelledby="itemInfoModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <form method="POST" action="{% url "delete_item_kitchen" id=kitchen.id %}" novalidate>
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="item-name">Delete item?</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body pb-0 overflow-hidden">
                        <div class="mb-2">Are you sure you want to delete <b id="item-name"></b>?</div>
                        {% comment %}<div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="should-add-to-shoplist">
                            <label class="form-check-label" for="should-add-to-shoplist">
                                Add to shopping list
                            </label>
                        </div>{% endcomment %}
                        {{ remove_item_form|crispy }}
                    </div>
                    <div class="modal-footer d-flex-grow-1-child">
                        <button type="button" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#itemInfoModal" class="btn btn-outline-secondary">Do not delete</button>
                        <button type="submit" class="btn btn-danger"><i class="bi bi-trash-fill"></i>&nbsp;&nbsp;Remove</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    {# invite users modal #}
    <div class="modal fade" id="inviteUsersModal" tabindex="-1" aria-labelledby="inviteUsersModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <form method="POST" action="{% url 'kitchen_invite_users' id=kitchen.id %}" novalidate class="needs-validation">
                    <div class="modal-header">
                        <h5 class="modal-title">Invite users</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% csrf_token %}
                        <fieldset class="form-group">
                            {{ invite_users_form|crispy }}
                        </fieldset>
                    </div>
                    <div class="modal-footer d-flex-grow-1-child">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Back</button>
                        <button type="submit" class="btn btn-success" id="codeNotFoundModalSuccessButton">Invite</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}